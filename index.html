<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TPAO Petroleum Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="index.css">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

<!-- Overlay -->
<div id="overlay" onclick="closeSidebar()"></div>

<!-- Menu Button -->
<button class="menu-btn" onclick="toggleSidebar()">☰</button>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <h2 class="logo">TPAO</h2>
  <nav>
    <a class="active" onclick="navigate('dashboard')">Dashboard</a>
    <a onclick="navigate('production')">Production</a>
    <a onclick="navigate('map')">Oil Fields</a>
  </nav>
</aside>

<!-- Main Content -->
<main class="main">

  <!-- Dashboard -->
  <section id="dashboard" class="page active">
    <h1>Petroleum Operations Overview</h1>
    <div class="cards">
      <div class="card"><h3>Daily Production</h3><p>1.45M bbl</p></div>
      <div class="card"><h3>Active Fields</h3><p>37</p></div>
      <div class="card"><h3>Countries</h3><p>6</p></div>
      <div class="card"><h3>Revenue</h3><p>$18.2B</p></div>
    </div>
  </section>

  <!-- Production -->
  <section id="production" class="page">
    <h1>Oil Production</h1>
    <canvas id="productionChart"></canvas>
  </section>

  <!-- Map -->
  <section id="mapPage" class="page">
    <h1>TPAO Oil Fields</h1>
    <div id="map"></div>
  </section>

</main>
  
<script>
/* ===== GLOBAL STATE ===== */
let currentPage = 'dashboard';
let sidebarOpen = false;

/* ===== ELEMENTS ===== */
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');

/* ===== INITIAL HISTORY LOCK ===== */
history.replaceState({ page: 'dashboard' }, "", "#dashboard");

/* ===== SIDEBAR ===== */
function toggleSidebar() {
  sidebar.classList.add('show');
  overlay.classList.add('show');
  sidebarOpen = true;

  history.pushState({ sidebar: true }, "");
}

function closeSidebar() {
  sidebar.classList.remove('show');
  overlay.classList.remove('show');
  sidebarOpen = false;
}

/* ===== PAGE SWITCH ===== */
function navigate(page) {
  if (page === currentPage) {
    closeSidebar();
    return;
  }

  showPage(page);
  history.pushState({ page }, ``, `#${page}`);
  currentPage = page;
  closeSidebar();
}

/* ===== SHOW PAGE ===== */
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));

  if (page === 'map') {
    document.getElementById('mapPage').classList.add('active');
    setTimeout(initMap, 300);
  } else {
    document.getElementById(page).classList.add('active');
  }

  document
    .querySelector(`.sidebar a[onclick="navigate('${page}')"]`)
    ?.classList.add('active');
}

/* ===== BACK BUTTON (THE REAL FIX) ===== */
window.addEventListener('popstate', (e) => {

  /* 1️⃣ If sidebar is open → close it */
  if (sidebarOpen) {
    closeSidebar();
    return;
  }

  /* 2️⃣ If history state has page → go to it */
  if (e.state && e.state.page) {
    showPage(e.state.page);
    currentPage = e.state.page;
    return;
  }

  /* 3️⃣ SAFETY: never exit site directly */
  showPage('dashboard');
  currentPage = 'dashboard';
  history.pushState({ page: 'dashboard' }, "", "#dashboard");
});

/* ===== CHART ===== */
new Chart(document.getElementById('productionChart'), {
  type: 'line',
  data: {
    labels: ['Jan','Feb','Mar','Apr','May','Jun'],
    datasets: [{
      label: 'Barrels / Day',
      data: [120,135,140,150,145,160],
      borderColor: '#22c55e',
      tension: 0.4
    }]
  }
});

/* ===== MAP ===== */
let mapLoaded = false;
function initMap() {
  if (mapLoaded) return;
  mapLoaded = true;

  const map = L.map('map').setView([39, 35], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  L.marker([37.88, 41.13]).addTo(map).bindPopup("Batman Oil Field");
  L.marker([40.4, 49.9]).addTo(map).bindPopup("Caspian Block");
}
</script>

</body>
  </html>
